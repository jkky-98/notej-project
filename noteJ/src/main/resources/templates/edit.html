<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<div th:insert="~{fragments/header :: header}"></div>
<head>
    <meta charset="UTF-8">
    <title>ê¸€ ì‘ì„±</title>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tagify/4.33.0/tagify.min.css" />
    <style>
        .write-container {
            max-width: 95%;
            margin: 0 auto;
            padding: 20px;
        }

        .title-input {
            font-size: 2rem;
            font-weight: bold;
            border: none;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

        .title-input:focus {
            outline: none;
            border-color: #6c757d;
        }

        .editor-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .editor-toolbar i {
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }

        .editor-toolbar i:hover {
            color: #495057;
        }

        .editor-textarea {
            border: none;
            border-bottom: 2px solid #ddd;
            width: 100%;
            height: 100vh;
            font-size: 1.2rem;
            resize: none;
            margin-top: 10px;
            color: #495057;
        }

        .editor-textarea:focus {
            outline: none;
            border-color: #6c757d;
        }

        .btn-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .btn-actions a, .btn-actions button {
            width: 150px;
        }

        .equal-height {
            display: flex;
            align-items: stretch; /* ìì‹ ìš”ì†Œ ë™ì¼ ë†’ì´ */
        }

        .card {
            height: 100%; /* ì¹´ë“œ ë†’ì´ ê· ë“± */
            display: flex;
            flex-direction: column; /* ìˆ˜ì§ ì •ë ¬ */
        }

        .card-body {
            flex-grow: 1; /* ë‚´ìš©ì´ í™•ì¥ ê°€ëŠ¥í•œ ì˜ì—­ */
        }

        /* ë²„íŠ¼ ì˜ì—­ì— ì—¬ìœ  ê³µê°„ ì¶”ê°€ */
        .btn-actions {
            margin-top: 20px; /* ë²„íŠ¼ ì˜ì—­ ìœ„ì— ì—¬ë°± */
        }
    </style>
</head>
<body>
<div class="write-container">
    <form th:object="${writeForm}" th:action="@{${currentUrl}}" method="post" enctype="multipart/form-data">
        <!-- ì œëª© ì…ë ¥ -->
        <input type="text" th:field="*{title}" class="form-control title-input" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
        <!-- íƒœê·¸ ì…ë ¥ -->
        <input type="hidden" th:field="*{tags}">
        <input type="text" name="tag-input" id="tag-input"class="form-control mb-3" placeholder="íƒœê·¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.">

        <input type="hidden" th:field="*{url}">

        <!-- ì—ë””í„°ë¥¼ ì ìš©í•  ìš”ì†Œ (ì»¨í…Œì´ë„ˆ) -->
        <div id="editor">
        </div>
        <input type="textarea" name="content" id="editor-content-provider" hidden style="display: block;">
        <section class="container mt-5">
            <div class="row mb-5">
                <!-- í¬ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸° -->
                <div class="col-md-6">
                    <h5 class="mb-3">í¬ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°</h5>
                    <div class="card">
                        <div class="card-body text-center">
                            <!-- ì¸ë„¤ì¼ ì—…ë¡œë“œ -->
                            <div class="mb-3">
                                <label for="thumbnail" class="form-label">ì¸ë„¤ì¼ ì—…ë¡œë“œ</label>
                                <input type="file" class="form-control" id="thumbnail" th:field="*{thumbnail}">
                            </div>
                            <!-- ê°„ëµí•œ ì†Œê°œ -->
                            <textarea th:field="*{postSummary}" class="form-control" rows="4" placeholder="ë‹¹ì‹ ì˜ í¬ìŠ¤íŠ¸ë¥¼ ì§§ê²Œ ì†Œê°œí•´ë³´ì„¸ìš”."></textarea>
                            <div class="text-end mt-1">
                                <small>0/150</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ê³µê°œ ì„¤ì • -->
                <div class="col-md-6">
                    <h5 class="mb-3">ê³µê°œ ì„¤ì •</h5>
                    <div class="card">
                        <div class="card-body">
                            <!-- ê³µê°œ ì—¬ë¶€ -->
                            <div class="mb-3">
                                <label class="form-label">ê³µê°œ ì„¤ì •</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" th:field="*{open}" id="public" value="true">
                                    <label class="btn btn-outline-success" for="public">ì „ì²´ ê³µê°œ</label>

                                    <input type="radio" class="btn-check" th:field="*{open}" id="private" value="false">
                                    <label class="btn btn-outline-danger" for="private">ë¹„ê³µê°œ</label>
                                </div>
                            </div>
                            <!-- URL ì„¤ì • -->
                            <div class="mb-3">
                                <label for="url" class="form-label">URL ì„¤ì •</label>
                                <div class="input-group">
                                    <span class="input-group-text" th:text="ì§ì ‘ì…ë ¥">@aal2525/</span>
                                    <input type="text" class="form-control" id="url" th:field="*{url}" placeholder="í¬ìŠ¤íŠ¸ URLì„ ì…ë ¥í•˜ì„¸ìš”.">
                                </div>
                            </div>
                            <!-- ì‹œë¦¬ì¦ˆ ì„¤ì • -->
                            <div class="mb-3">
                                <label for="seriesNameList" class="form-label">ì‹œë¦¬ì¦ˆ ì„¤ì •</label>
                                <div class="input-group">
                                    <!-- Dropdown for series -->
                                    <select class="form-select" id="seriesNameList" th:field="*{series}">
                                        <option value="" disabled selected>ì‹œë¦¬ì¦ˆ ì„ íƒ</option>
                                        <!-- ì‹œë¦¬ì¦ˆ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜ë³µí•´ì„œ ì˜µì…˜ ìƒì„± -->
                                        <option th:each="series : *{seriesList}" th:value="${series}" th:text="${series}"></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <!-- ë²„íŠ¼ ê·¸ë£¹ -->
            <div class="btn-actions">
                <a href="/" class="btn btn-outline-secondary">ë‚˜ê°€ê¸°</a>
                <div>
                    <button type="button" class="btn btn-outline-success me-2">ì„ì‹œì €ì¥</button>
                    <button type="submit" class="btn btn-success">ì¶œê°„í•˜ê¸°</button>
                </div>
            </div>
        </section>

        <!-- CSS ìŠ¤íƒ€ì¼ -->
        <style>
            textarea[name="postSummary"] {
                resize: none;
            }
        </style>

    </form>
</div>

<!-- TUI ì—ë””í„° JS CDN -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<!-- Tagify -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tagify/4.33.0/tagify.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script th:inline="javascript">
    let writeFormContent = /*[[${writeForm.content ?: ''}]]*/ '';

    window.editor = new toastui.Editor({
        el: document.querySelector('#editor'), // ì—ë””í„°ë¥¼ ì ìš©í•  ìš”ì†Œ (ì»¨í…Œì´ë„ˆ)
        height: 'auto',                        // ì—ë””í„° ì˜ì—­ì˜ ë†’ì´ ê°’ (OOOpx || auto)
        initialEditType: 'markdown',            // ìµœì´ˆë¡œ ë³´ì—¬ì¤„ ì—ë””í„° íƒ€ì… (markdown || wysiwyg)
        initialValue: writeFormContent || '',   // ë‚´ìš©ì˜ ì´ˆê¸° ê°’ìœ¼ë¡œ, ë°˜ë“œì‹œ ë§ˆí¬ë‹¤ìš´ ë¬¸ìì—´ í˜•íƒœì—¬ì•¼ í•¨
        previewStyle: 'vertical',               // ë§ˆí¬ë‹¤ìš´ í”„ë¦¬ë·° ìŠ¤íƒ€ì¼ (tab || vertical)
        placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.',
        hooks: {
            async addImageBlobHook(blob, callback) { // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë¡œì§ ì»¤ìŠ¤í…€
                try {
                    /*
                     * 1. ì—ë””í„°ì— ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ë¥¼ FormData ê°ì²´ì— ì €ì¥
                     *    (ì´ë•Œ, ì»¨íŠ¸ë¡¤ëŸ¬ uploadEditorImage ë©”ì„œë“œì˜ íŒŒë¼ë¯¸í„°ì¸ 'image'ì™€ formDataì— append í•˜ëŠ” key('image')ê°’ì€ ë™ì¼í•´ì•¼ í•¨)
                     */
                    const formData = new FormData();
                    formData.append('image', blob);

                    // 2. FileApiController - uploadEditorImage ë©”ì„œë“œ í˜¸ì¶œ
                    const response = await fetch('/editor/image-upload', {
                        method : 'POST',
                        body : formData,
                    });

                    // 3. ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì „ë‹¬ë°›ì€ ë””ìŠ¤í¬ì— ì €ì¥ëœ íŒŒì¼ëª…
                    const filename = await response.text();
                    console.log('ì„œë²„ì— ì €ì¥ëœ íŒŒì¼ëª… : ', filename);

                    // 4. addImageBlobHookì˜ callback í•¨ìˆ˜ë¥¼ í†µí•´, ë””ìŠ¤í¬ì— ì €ì¥ëœ ì´ë¯¸ì§€ë¥¼ ì—ë””í„°ì— ë Œë”ë§
                    const imageUrl = `/editor/image-print?filename=${filename}`;
                    callback(imageUrl, 'image alt attribute');

                } catch (error) {
                    console.error('ì—…ë¡œë“œ ì‹¤íŒ¨ : ', error);
                }
            }
        }

    });
    document.querySelector('form').addEventListener('submit', function (event) {
    // ì—ë””í„°ì—ì„œ ì‘ì„±ëœ ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const content = editor.getMarkdown();

    const encodedContent = encodeURIComponent(content);

    // ìˆ¨ê²¨ì§„ input íƒœê·¸ì— ê°’ì„ ë„£ìŠµë‹ˆë‹¤.
    document.querySelector('#editor-content-provider').value = encodedContent;
    });
</script>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
        const input = document.querySelector('input[name=tag-input]');
        const hiddenInput = document.querySelector('#tags');

        // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ íƒœê·¸ ê°’ ì´ˆê¸°í™” (ì˜ˆ: ["spring", "íƒœê·¸1"])
        const initialTags = /*[[${writeForm.tags}]]*/ '["spring", "íƒœê·¸1"]';

        // Tagify ì´ˆê¸°í™” ë° ì´ˆê¸° íƒœê·¸ ì„¤ì •
        const tagify = new Tagify(input, {
            whitelist: initialTags, // ì…ë ¥ ê°€ëŠ¥í•œ íƒœê·¸ì— ì´ˆê¸°ê°’ í¬í•¨
        });

        // ì´ˆê¸° íƒœê·¸ ì„¤ì •
        tagify.addTags(initialTags);

        // ìˆ¨ê²¨ì§„ í•„ë“œì— ì´ˆê¸° ê°’ ì„¤ì •
        hiddenInput.value = initialTags.join(',');

        // íƒœê·¸ ë³€ê²½ ì‹œ ìˆ¨ê²¨ì§„ í•„ë“œ ì—…ë°ì´íŠ¸
        tagify.on('change', () => {
            hiddenInput.value = tagify.value.map(tag => tag.value).join(',');
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        var input = document.querySelector('input[name=tag-input]');

        const hiddenInput = document.querySelector('#tags');
        const tagify = new Tagify(input);

        // íƒœê·¸ ë³€ê²½ ì‹œ ìˆ¨ê²¨ì§„ í•„ë“œì— ê°’ ì €ì¥
        tagify.on('change', () => {
            hiddenInput.value = tagify.value.map(tag => tag.value);
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const autoSaveInterval = 10000; // 1ë¶„ (60,000ms)
        const editor = window.editor; // Toast UI Editor ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°

        function autoEdit() {
            if (document.hidden) {
                console.log("ë¸Œë¼ìš°ì €ê°€ ë¹„í™œì„±í™” ìƒíƒœì…ë‹ˆë‹¤. ìë™ ì €ì¥ì„ ê±´ë„ˆëœë‹ˆë‹¤.");
                return;
            }

            const content = encodeURIComponent(editor.getMarkdown()); // ì—ë””í„°ì—ì„œ ì‘ì„± ì¤‘ì¸ ë‚´ìš©
            const title = document.querySelector('input[name="title"]').value; // ì œëª© ê°€ì ¸ì˜¤ê¸°
            const tags = document.querySelector('#tags').value; // íƒœê·¸ ê°€ì ¸ì˜¤ê¸°
            const tagsList = tags.split(','); // ì‰¼í‘œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¬¸ìì—´ ë¶„ë¦¬
            const postUrl = window.location.pathname.split('/').filter(Boolean).pop();

            console.log(postUrl);

            // ì œëª©ì´ ë¹ˆê°’ì¸ ê²½ìš° ì‹¤í–‰ ì¤‘ë‹¨
            if (!title) {
                console.warn("ì œëª©ì´ ë¹„ì–´ìˆì–´ ìë™ ì €ì¥ì„ ê±´ë„ˆëœë‹ˆë‹¤.");
                return;
            }

            // Ajax ìš”ì²­ ìƒì„±
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/api/write/auto-edit", true); // ë¹„ë™ê¸° POST ìš”ì²­
            xhr.setRequestHeader("Content-Type", "application/json");

            // ìš”ì²­ ë°ì´í„° ì¤€ë¹„
            const data = JSON.stringify({
                title: title,
                content: content,
                tags: tagsList,
                postUrl: postUrl
            });

            console.log(data);

            // ìš”ì²­ ì „ì†¡
            xhr.send(data);

            // ìš”ì²­ ìƒíƒœ í™•ì¸
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        console.log("ìë™ ì €ì¥ ì„±ê³µ:", xhr.responseText);

                        // JSON ë°ì´í„° íŒŒì‹±
                        const response = JSON.parse(xhr.responseText);

                        // postUrlì´ ì¡´ì¬í•  ê²½ìš° ë¦¬ë‹¤ì´ë ‰íŠ¸
                        if (response) {
                            console.log("ìë™ ì—…ë°ì´íŠ¸ ì„±ê³µ")
                            new Toastify({
                                text: "ğŸ¦„ ê²Œì‹œê¸€ ìë™ ì €ì¥ ì„±ê³µ!",
                                duration: 5000, // autoClose 5000ms
                                gravity: "top", // top-right ìœ„ì¹˜ ì„¤ì •
                                position: "right",
                                stopOnFocus: true, // pauseOnHover
                                close: true, // closeOnClick
                                style: {
                                    background: "linear-gradient(to right, #00b09b, #96c93d)", // í…Œë§ˆ ìŠ¤íƒ€ì¼
                                    color: "#fff",
                                    borderRadius: "8px",
                                    boxShadow: "0 2px 6px rgba(0, 0, 0, 0.15)",
                                }
                            }).showToast();
                        } else {
                            console.error("postUrlì´ ì‘ë‹µì— ì—†ìŠµë‹ˆë‹¤.");
                        }

                    } else {
                        console.error("ìë™ ì €ì¥ ì‹¤íŒ¨:", xhr.statusText);
                    }
                }
            };
        }

        // 1ë¶„ë§ˆë‹¤ ìë™ ì €ì¥ ì‹¤í–‰
        setInterval(autoEdit, autoSaveInterval);
    });
</script>
</body>
</html>
