<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js
"></script>
<link href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css
" rel="stylesheet">
<!-- Include the header fragment -->
<div th:insert="~{fragments/header :: header}"></div>
<body>
<!-- Include the navigation fragment -->
<div th:insert="~{fragments/header :: navigation}">
</div>
<div>Home</div>
<div class="container-fluid">
    <div class="row">
        <div class="col-8">
            <div id="terminal" style="width: 100%; height: 400px;"></div>
        </div>
        <div class="col-4">
            무엇이 들어가려나
        </div>
    </div>
</div>

<script>
    function printAsciiArt(term) {
        const lines = [
            String.raw` $ ▐▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▌`,
            String.raw` $ ▐                                                                                   ▌`,
            String.raw` $ ▐              _ _         __    __           _     _   _                           ▌`,
            String.raw` $ ▐    /\  /\___| | | ___   / / /\ \ \___  _ __| | __| | / \                          ▌`,
            String.raw` $ ▐   / /_/ / _ \ | |/ _ \  \ \/  \/ / _ \| '__| |/ _` + "`" + String.raw` |/  /                          ▌`,
            String.raw` $ ▐  / __  /  __/ | | (_) |  \  /\  / (_) | |  | | (_| /\_/                           ▌`,
            String.raw` $ ▐  \/ /_/ \___|_|_|\___/    \/  \/ \___/|_|  |_|\__,_\/                             ▌`,
            String.raw` $ ▐                                                                                   ▌`,
            String.raw` $ ▐   __    __     _                            _              __      _        __    ▌`,
            String.raw` $ ▐  / / /\ \ \___| | ___ ___  _ __ ___   ___  | |_ ___     /\ \ \___ | |_ ___  \ \   ▌`,
            String.raw` $ ▐  \ \/  \/ / _ \ |/ __/ _ \| '_ ` + "`" + String.raw` _ \ / _ \ | __/ _ \   /  \/ / _ \| __/ _ \  \ \  ▌`,
            String.raw` $ ▐   \  /\  /  __/ | (_| (_) | | | | | |  __/ | || (_) | / /\  / (_) | ||  __/\_/ /  ▌`,
            String.raw` $ ▐    \/  \/ \___|_|\___\___/|_| |_| |_|\___|  \__\___/  \_\ \/ \___/ \__\___\___/   ▌`,
            String.raw` $ ▐                                                                                   ▌`,
            String.raw` $ ▐▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▌`,
            String.raw` $  `
        ];
        lines.forEach(line => term.writeln(line));
    }



</script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var username = /*[[${sessionUser != null and sessionUser.username != '' ? sessionUser.username : 'nologin'}]]*/ 'nologin';

    const prompt = (username && username !== 'nologin')
        ? " \x1b[1;3;94m" + username + "\x1b[0m" + "@notej:# ~ "
        : " \x1b[1;3;95m" + "nologin" + "\x1b[0m" + "@notej:# ~ ";

    console.log(prompt);
    /*]]>*/

    // 터미널 인스턴스 생성 및 오픈
    const term = new Terminal({
        fontFamily: 'Lucida Sans, monospace',
        fontSize: 14,
        letterSpacing: 0,
        lineHeight: 1.0,
        cols: 200
    });
    term.resize(200, 30);
    term.open(document.getElementById('terminal'));
    term.focus();

    // 초기 프롬프트 설정 및 안내 메시지 출력
    term.writeln(' $');
    term.writeln(' $ 🚀  NOTEJ에 오신걸 환영합니다 \x1B[1;3;32m\'help\'\x1B[0m 명령어로 하여금 다양한 기능을 수행해보세요!');
    term.writeln(' $');
    printAsciiArt(term);
    term.write(prompt);

    // 커맨드 버퍼 및 히스토리 초기화
    var commandBuffer = '';
    var commandHistory = []; // 이전에 입력한 명령어들을 저장
    var historyIndex = 0;    // 현재 히스토리 인덱스. 기본적으로 히스토리의 끝(새로운 명령 입력 상태)

    function processCommand(cmd) {
        // 예시: 'help' 명령어에 대한 처리. 실제 구현에 맞게 수정하세요.
        fetch('/api/execute-command', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ command: cmd })
        })
            .then(response => response.json())
            .then(data => {
                console.log(data.result);
                term.writeln('\r\n' + data.result);
                term.write(prompt);
            })
            .catch(error => {
                term.writeln('\r\nError: ' + error);
                term.write(prompt);
            });
    }

    // 키 입력 이벤트 처리
    term.onData(function(data) {
        // 화살표 키 (위: \x1b[A, 아래: \x1b[B) 처리
        if (data === '\x1b[A') {  // Up arrow
            if (commandHistory.length > 0) {
                // 히스토리 인덱스가 0보다 크면 위로 이동
                if (historyIndex > 0) {
                    historyIndex--;
                }
                // 현재 히스토리 명령어로 commandBuffer 설정
                commandBuffer = commandHistory[historyIndex];
                // 현재 줄 클리어 후 프롬프트와 commandBuffer 재출력
                term.write('\x1B[2K\r' + prompt + commandBuffer);
            }
        }
        else if (data === '\x1b[B') {  // Down arrow
            if (commandHistory.length > 0) {
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    commandBuffer = commandHistory[historyIndex];
                } else {
                    // 마지막 명령어 이후에는 빈 문자열로 초기화
                    historyIndex = commandHistory.length;
                    commandBuffer = '';
                }
                term.write('\x1B[2K\r' + prompt + commandBuffer);
            }
        }
        // 백스페이스 처리: 일반적으로 \x7F 또는 \b
        else if (data === '\x7F' || data === '\b') {
            if (commandBuffer.length > 0) {
                commandBuffer = commandBuffer.slice(0, -1);
                term.write('\x1B[2K\r' + prompt + commandBuffer);
            }
        }
        // 엔터 처리: 줄바꿈 후 프롬프트 재출력
        else if (data === '\r') {
            term.write('\r\n');
            if (commandBuffer.trim() !== '') {
                // 명령어를 히스토리에 저장 (성공 여부와 상관없이)
                commandHistory.push(commandBuffer);
                // 히스토리의 길이가 30개를 초과하면 가장 오래된 항목 제거
                if (commandHistory.length > 30) {
                    commandHistory.shift();
                }
                // 히스토리 인덱스를 히스토리의 끝으로 업데이트
                historyIndex = commandHistory.length;

                if (username !== 'nologin') {
                    processCommand(commandBuffer);
                    console.log("명령어 서버 전달 함수 콜 완료");
                    console.log(commandBuffer);
                } else {
                    term.writeln("⚠️  로그인이 필요합니다 🚫");
                    term.write(prompt);
                }
            } else {
                term.write(prompt);
            }
            commandBuffer = '';
        }
        // 일반 문자 입력 처리
        else {
            commandBuffer += data;
            term.write(data);
        }
    });
</script>


<!-- Bootstrap JS -->
</body>
</html>
