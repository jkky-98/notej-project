<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js
"></script>
<link href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css
" rel="stylesheet">
<!-- Include the header fragment -->
<div th:insert="~{fragments/header :: header}"></div>
<body>
<!-- Include the navigation fragment -->
<div th:insert="~{fragments/header :: navigation}">
</div>
<div class="container-fluid m-3">
    <div class="row mt-4">
        <div class="col-md-9 col-auto">
            <h2 class="mb-2 fw-bold">User Console</h2>
            <h6 class="text-body-tertiary fw-semibold">ìœ ì € ì½˜ì†”ì„ í†µí•´ ë¸”ë¡œê·¸ í†µê³„ ì¶”ì  ë° ê´€ë¦¬ë¥¼ í•´ë³´ì„¸ìš”!</h6>
        </div>
    </div>
    <div class="row">
        <div class="col-8">
            <div class="card h-100 shadow-sm rounded-lg">
                <div class="card-header">
                    <h5 class="card-title mb-0">Terminal</h5>
                    <small class="text-muted">ëª…ë ¹ì–´ë¥¼ í†µí•´ ë¸”ë¡œê·¸ ê´€ë¦¬ ë° í†µê³„ê¸°ëŠ¥ì„ ìˆ˜í–‰í•´ë³´ì„¸ìš”.</small>
                </div>
                <div class="card-body p-0">
                    <div id="terminal" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function printAsciiArt(term) {
        // ì‚¬ìš©ì ì§€ì • ìƒ‰ìƒê³¼ ë¦¬ì…‹ ì½”ë“œ (ANSI escape sequence)
        const userColor = "\x1b[38;2;0;123;255m";
        const resetColor = "\x1b[0m";

        const lines = [
            String.raw` $ â–â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–Œ`,
            String.raw` $ â–                                                                                   â–Œ`,
            String.raw` $ â–              _ _         __    __           _     _   _                           â–Œ`,
            String.raw` $ â–    /\  /\___| | | ___   / / /\ \ \___  _ __| | __| | / \                          â–Œ`,
            String.raw` $ â–   / /_/ / _ \ | |/ _ \  \ \/  \/ / _ \| '__| |/ _` + "`" + String.raw` |/  /                          â–Œ`,
            String.raw` $ â–  / __  /  __/ | | (_) |  \  /\  / (_) | |  | | (_| /\_/                           â–Œ`,
            String.raw` $ â–  \/ /_/ \___|_|_|\___/    \/  \/ \___/|_|  |_|\__,_\/                             â–Œ`,
            String.raw` $ â–                                                                                   â–Œ`,
            String.raw` $ â–   __    __     _                            _              __      _        __    â–Œ`,
            String.raw` $ â–  / / /\ \ \___| | ___ ___  _ __ ___   ___  | |_ ___     /\ \ \___ | |_ ___  \ \   â–Œ`,
            String.raw` $ â–  \ \/  \/ / _ \ |/ __/ _ \| '_ ` + "`" + String.raw` _ \ / _ \ | __/ _ \   /  \/ / _ \| __/ _ \  \ \  â–Œ`,
            String.raw` $ â–   \  /\  /  __/ | (_| (_) | | | | | |  __/ | || (_) | / /\  / (_) | ||  __/\_/ /  â–Œ`,
            String.raw` $ â–    \/  \/ \___|_|\___\___/|_| |_| |_|\___|  \__\___/  \_\ \/ \___/ \__\___\___/   â–Œ`,
            String.raw` $ â–                                                                                   â–Œ`,
            String.raw` $ â–â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–Œ`,
            String.raw` $  `
        ];

        lines.forEach(line => {
            // ë§Œì•½ ì–‘ìª½ì— í…Œë‘ë¦¬ ì—­í• ì˜ 'â–'ì™€ 'â–Œ'ê°€ ìˆë‹¤ë©´,
            const leftIndex = line.indexOf('â–');
            const rightIndex = line.lastIndexOf('â–Œ');

            // ì–‘ìª½ í…Œë‘ë¦¬ê°€ ë°œê²¬ë˜ì—ˆê³ , ê·¸ ì‚¬ì´ì— ë‚´ìš©ì´ ìˆëŠ” ê²½ìš°
            if (leftIndex !== -1 && rightIndex !== -1 && rightIndex > leftIndex) {
                const left = line.substring(0, leftIndex + 1);
                const middle = line.substring(leftIndex + 1, rightIndex);
                const right = line.substring(rightIndex);

                /*
                   ë§Œì•½ ë°•ìŠ¤ ë‚´ë¶€ ë‚´ìš©ì´ ë‹¨ìˆœ ê³µë°±ì´ë‚˜ ë°˜ë³µë˜ëŠ” í…Œë‘ë¦¬ ë¬¸ì(ì˜ˆ: 'â–€', 'â–„')ë¡œë§Œ êµ¬ì„±ë˜ì–´ ìˆë‹¤ë©´
                   (ì¦‰, borderë¼ì¸ì¸ ê²½ìš°)ì—ëŠ” ìƒ‰ìƒì„ ì ìš©í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.
                */
                if (/^[\sâ–€â–„]+$/.test(middle)) {
                    term.writeln(line);
                } else {
                    term.writeln(left + userColor + middle + resetColor + right);
                }
            } else {
                // í…Œë‘ë¦¬ íŒ¨í„´ì´ ì—†ëŠ” ë¼ì¸ì€ ê·¸ëŒ€ë¡œ ì¶œë ¥
                term.writeln(line);
            }
        });
    }



</script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var username = /*[[${sessionUser != null and sessionUser.username != '' ? sessionUser.username : 'nologin'}]]*/ 'nologin';

    const prompt = (username && username !== 'nologin')
        ? " \x1b[1;3;94m" + username + "\x1b[0m" + "@notej:# ~ "
        : " \x1b[1;3;95m" + "nologin" + "\x1b[0m" + "@notej:# ~ ";

    // ì‚¬ìš©ì ì…ë ¥ ê¸€ìì— ì ìš©í•  ìƒ‰ìƒ (RGB: 0,123,255)
    const userColor = "\x1b[38;2;0;123;255m";
    const resetColor = "\x1b[0m";

    console.log(prompt);

    // í„°ë¯¸ë„ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì˜¤í”ˆ
    const term = new Terminal({
        fontFamily: 'Lucida Sans, monospace',
        fontSize: 14,
        letterSpacing: 0,
        lineHeight: 1.0,
        cols: 120,
        rows: 35,
        theme: {
            background: '#ffffff',   // ë°°ê²½ìƒ‰
            foreground: '#000000',   // ê¸°ë³¸ ê¸€ììƒ‰ (í”„ë¡¬í”„íŠ¸ ë“±)
            cursor: '#007bff',       // ì»¤ì„œ ìƒ‰ìƒ
            cursorAccent: '#ffffff'  // ì»¤ì„œ ë‚´ë¶€ í…ìŠ¤íŠ¸ ìƒ‰ìƒ
        },
        cursorBlink: true  // ì»¤ì„œ ê¹œë¹¡ì„ í™œì„±í™”
    });

    term.open(document.getElementById('terminal'));
    term.focus();

    // ì´ˆê¸° í”„ë¡¬í”„íŠ¸ ë° ì•ˆë‚´ ë©”ì‹œì§€ ì¶œë ¥
    term.writeln(' $');
    term.writeln(' $ ğŸš€  NOTEJì— ì˜¤ì‹ ê±¸ í™˜ì˜í•©ë‹ˆë‹¤ ' + userColor + '\'help\'' + resetColor + ' ëª…ë ¹ì–´ë¡œ ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•´ë³´ì„¸ìš”!');
    term.writeln(' $');
    printAsciiArt(term);
    term.write(prompt);

    // ì»¤ë§¨ë“œ ë²„í¼ ë° íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
    var commandBuffer = '';
    var commandHistory = []; // ì´ì „ì— ì…ë ¥í•œ ëª…ë ¹ì–´ë“¤ì„ ì €ì¥
    var historyIndex = 0;    // í˜„ì¬ íˆìŠ¤í† ë¦¬ ì¸ë±ìŠ¤. ê¸°ë³¸ì ìœ¼ë¡œ íˆìŠ¤í† ë¦¬ì˜ ë(ìƒˆë¡œìš´ ëª…ë ¹ ì…ë ¥ ìƒíƒœ)

    function redrawCommandBuffer() {
        // í˜„ì¬ ì¤„ í´ë¦¬ì–´ í›„ í”„ë¡¬í”„íŠ¸ì™€ ìƒ‰ìƒì´ ì ìš©ëœ ì»¤ë§¨ë“œ ë²„í¼ ì¬ì¶œë ¥
        term.write('\x1B[2K\r' + prompt + userColor + commandBuffer + resetColor);
    }

    function processCommand(cmd) {
        if (cmd === "help") {
            term.writeln(" ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´(ë¡œê·¸ì¸ í•„ìš”)");
            term.writeln("    - \x1b[31;1mlike all\x1b[0m: ì‚¬ìš©ìê°€ ì–»ì€ ì´ ì¢‹ì•„ìš” ê°œìˆ˜ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.");
            term.writeln("    - \x1b[31;1mlike all series = {seriesName}\x1b[0m : seriesNameì— ì†Œì†ëœ ê²Œì‹œê¸€ë“¤ì˜ ì´ ì¢‹ì•„ìš” ê°œìˆ˜ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.");
            term.writeln("    - \x1b[31;1mseries change {oldSeriesName} to {newSeriesName}\x1b[0m: ì‹œë¦¬ì¦ˆ(old) ì•ˆì˜ ëª¨ë“  ê²Œì‹œê¸€ì˜ ì‹œë¦¬ì¦ˆ(new)ë¥¼ ë°”ê¿‰ë‹ˆë‹¤.");
            term.writeln("                                                          ë³€ê²½ ì‹œë¦¬ì¦ˆëª…ì´ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš° ì‹œë¦¬ì¦ˆë¥¼ ìƒˆë¡œ ë§Œë“­ë‹ˆë‹¤.");
            term.write(prompt);
            return;
        }

        // ì˜ˆì‹œ: 'help' ëª…ë ¹ì–´ì— ëŒ€í•œ ì²˜ë¦¬. ì‹¤ì œ êµ¬í˜„ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”.
        fetch('/api/execute-command', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ command: cmd })
        })
            .then(response => response.json())
            .then(data => {
                console.log(data.result);
                term.writeln('\r\n' + data.result);
                term.write(prompt);
            })
            .catch(error => {
                term.writeln('\r\nError: ' + error);
                term.write(prompt);
            });
    }

    // í‚¤ ì…ë ¥ ì´ë²¤íŠ¸ ì²˜ë¦¬
    term.onData(function(data) {
        // í™”ì‚´í‘œ í‚¤ (ìœ„: \x1b[A, ì•„ë˜: \x1b[B) ì²˜ë¦¬
        if (data === '\x1b[A') {  // Up arrow
            if (commandHistory.length > 0) {
                if (historyIndex > 0) {
                    historyIndex--;
                }
                commandBuffer = commandHistory[historyIndex];
                redrawCommandBuffer();
            }
        }
        else if (data === '\x1b[B') {  // Down arrow
            if (commandHistory.length > 0) {
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    commandBuffer = commandHistory[historyIndex];
                } else {
                    historyIndex = commandHistory.length;
                    commandBuffer = '';
                }
                redrawCommandBuffer();
            }
        }
        // ë°±ìŠ¤í˜ì´ìŠ¤ ì²˜ë¦¬: ì¼ë°˜ì ìœ¼ë¡œ \x7F ë˜ëŠ” \b
        else if (data === '\x7F' || data === '\b') {
            if (commandBuffer.length > 0) {
                commandBuffer = commandBuffer.slice(0, -1);
                redrawCommandBuffer();
            }
        }
        // ì—”í„° ì²˜ë¦¬: ì¤„ë°”ê¿ˆ í›„ í”„ë¡¬í”„íŠ¸ ì¬ì¶œë ¥
        else if (data === '\r') {
            term.write('\r\n');
            if (commandBuffer.trim() !== '') {
                commandHistory.push(commandBuffer);
                if (commandHistory.length > 30) {
                    commandHistory.shift();
                }
                historyIndex = commandHistory.length;

                if (username !== 'nologin') {
                    processCommand(commandBuffer);
                    console.log("ëª…ë ¹ì–´ ì„œë²„ ì „ë‹¬ í•¨ìˆ˜ ì½œ ì™„ë£Œ");
                    console.log(commandBuffer);
                } else {
                    term.writeln("âš ï¸  ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤ ğŸš«");
                    term.write(prompt);
                }
            } else {
                term.write(prompt);
            }
            commandBuffer = '';
        }
        // ì¼ë°˜ ë¬¸ì ì…ë ¥ ì²˜ë¦¬
        else {
            commandBuffer += data;
            // ì¶œë ¥ ì‹œë§ˆë‹¤ ì‚¬ìš©ì ì…ë ¥ ê¸€ìëŠ” ì§€ì •í•œ ìƒ‰ìƒìœ¼ë¡œ ì ìš©
            term.write(userColor + data + resetColor);
        }
    });
    /*]]>*/
</script>



<!-- Bootstrap JS -->
</body>
</html>
